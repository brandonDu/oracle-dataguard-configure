# Oracle dataguard 快速配置(脚本篇)

```markdown
主库：
ip: 192.168.0.2
db_name: orcl
db_unique_name: primary
备机：
ip: 192.168.0.3
db_name: orcl
db_unique_name: standby
```

1. 主安装oracle和database
2. 备库仅仅安装oracle
3. 备库执行create_instance_orcl.bat  `创建实例并创建目录结构`

### 主库设置

1. 查看主库安装信息，执行脚本`select _info_primary.bat`。 调用`check_infro_primary.sql`
2. 创建密码文件，执行脚本`orapwd.bat`。 (总是出现循环错误)
3. 启动强制归档并查看联机日志信息，执行脚本`enable_logging_redo.bat`。调用`check_logging_redo.sql`
4. 根据查询信息，调整`con_standby_redo_log.sql` 中的联机日志编号， 调用`con_stdby_redo.bat`
5. 设置主库归档模式，执行脚本`enable_archiving.bat`。 调用`archive_log.sql`
6. 设置主库初始化参数。调用脚本创建目录以及创建pfile文件。执行脚本`create_archive_dir.bat`。调用`create_primary_pfile.sql`
7. 在pfile文件结尾添加一下内容，如有调整，适量修改`*C:\oracle\pfileorcl.ora`。

```ora
db_name='orcl'
db_unique_name='primary'
LOG_ARCHIVE_CONFIG='DG_CONFIG=(primary,standby)'
LOG_ARCHIVE_DEST_1= 'LOCATION=C:\oracle\archive VALID_FOR=(ALL_LOGFILES,ALL_ROLES) DB_UNIQUE_NAME=primary'
LOG_ARCHIVE_DEST_2= 'SERVICE=standby LGWR ASYNC VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=standby'
LOG_ARCHIVE_DEST_STATE_1=ENABLE
LOG_ARCHIVE_DEST_STATE_2=ENABLE
REMOTE_LOGIN_PASSWORDFILE=EXCLUSIVE
LOG_ARCHIVE_FORMAT=log_%t_%s_%r.arc
LOG_ARCHIVE_MAX_PROCESSES=30

fal_server=standby
fal_client=primary
standby_file_management=auto
db_file_name_convert='standby','primary'
log_file_name_convert='C:\oracle\product\10.2.0\oradata\orcl','C:\oracle\product\10.2.0\oradata\orcl'
```

8. 根据pfile创建spfile文件，并restart oracle，执行脚本`pfile_to_spfile_restart.bat`。调用`pfile_to_spfile.sql`
9. 为备库创建控制文件，执行脚本`create_control_file.bat`。调用`create_standby_control.sql`。
10. 配置C:\oracle\product\10.2.0\db_1\NETWORK\ADMIN下的listener.ora和tsname.ora文件。

**Listener.ora**

```
# listener.ora Network Configuration File: C:\oracle\product\10.2.0\db_1\network\admin\listener.ora
# Generated by Oracle configuration tools.

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (SID_NAME = PLSExtProc)
      (ORACLE_HOME = C:\oracle\product\10.2.0\db_1)
      (PROGRAM = extproc)
    )
    (SID_DESC =
      (SID_NAME = orcl)
      (ORACLE_HOME = C:\oracle\product\10.2.0\db_1)
      (PROGRAM = orcl)
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1))
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.0.2)(PORT = 1521))
    )
  )

```

**Tsname.ora**

```
# tnsnames.ora Network Configuration File: C:\oracle\product\10.2.0\db_1\network\admin\tnsnames.ora
# Generated by Oracle configuration tools.

primary =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.0.2)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = primary)
    )
  )
standby =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.0.3)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = standby)
    )
  )

EXTPROC_CONNECTION_DATA =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1))
    )
    (CONNECT_DATA =
      (SID = PLSExtProc)
      (PRESENTATION = RO)
    )
  )
```

---

**此处涉及拷贝，请先shutdown主库oracle**

* 将主库的数据文件，控制文件，密码文件，以及pfile拷贝到备机相应目录下。
* 控制文件复制三个，修改名字为：CONTROL01.CTL，CONTROL02.CTL，CONTROL03.CTL， 并保存早C:\oracle\product\10.2.0\oradata\orcl下。保存数据文件到C:\oracle\product\10.2.0\oradata\orcl下。
* 保存密码文件到C:\oracle\product\10.2.0\db_1\database下。
* 创建路径：C:\oracle\archive

---

### 备机操作

1. 配置参数文件，修改pfile文件内容。

```
db_name='orcl'
db_unique_name='standby'
LOG_ARCHIVE_CONFIG='DG_CONFIG=(primary,standby)'
LOG_ARCHIVE_DEST_1= 'LOCATION=C:\oracle\archive VALID_FOR=(ALL_LOGFILES,ALL_ROLES) DB_UNIQUE_NAME=standby'
LOG_ARCHIVE_DEST_2= 'SERVICE=primary LGWR ASYNC VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=primary'
LOG_ARCHIVE_DEST_STATE_1=ENABLE
LOG_ARCHIVE_DEST_STATE_2=ENABLE
REMOTE_LOGIN_PASSWORDFILE=EXCLUSIVE
LOG_ARCHIVE_FORMAT=log_%t_%s_%r.arc
LOG_ARCHIVE_MAX_PROCESSES=30

fal_server=primary
fal_client=standby
standby_file_management=auto
db_file_name_convert='primary','standby'
log_file_name_convert='c:\oracle\product\10.2.0\oradata\orcl','c:\oracle\product\10.2.0\oradata\orcl'
```

2. 配置C:\oracle\product\10.2.0\db_1\NETWORK\ADMIN下的listener.ora和tsname.ora文件。

**Listener.ora**

```
# listener.ora Network Configuration File: C:\oracle\product\10.2.0\db_1\network\admin\listener.ora
# Generated by Oracle configuration tools.

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (SID_NAME = PLSExtProc)
      (ORACLE_HOME = C:\oracle\product\10.2.0\db_1)
      (PROGRAM = extproc)
    )
    (SID_DESC =
      (SID_NAME = orcl)
      (ORACLE_HOME = C:\oracle\product\10.2.0\db_1)
      (PROGRAM = orcl)
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1))
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.0.3)(PORT = 1521))
    )
  )
```

**Tsname.ora**

```
# tnsnames.ora Network Configuration File: C:\oracle\product\10.2.0\db_1\network\admin\tnsnames.ora
# Generated by Oracle configuration tools.

primary =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.0.2)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = primary)
    )
  )
standby =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.0.3)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = standby)
    )
  )

EXTPROC_CONNECTION_DATA =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1))
    )
    (CONNECT_DATA =
      (SID = PLSExtProc)
      (PRESENTATION = RO)
    )
  )

```

3. 生成spfile文件，执行脚本`std_create_spfile.bat`。调用`std_spfile_from_pfile.sql`
4. 挂载数据库。

```plsql
备库执行：SQL> startup mount;
主库执行：SQL> alter system switch logfile;
```

5. 备库添加redo日志。执行脚本`std_cre_redo_log.bat`， 调用`std_add_redo_log.sql`
6. 主库执行测试脚本`create_table_insert_random.bat`，调用`fun_random_test.sql`
7. 备库执行sql查询

```plsql
SELECT SEQUENCE#, FIRST_TIME, NEXT_TIME FROM V$ARCHIVED_LOG ORDER BY SEQUENCE#;
```

8. 查询备库数据是否插入，执行脚本`std_check_insert.bat` ， 调用`std_open_see.sql`


### 备机重启后操作

1. 调用`std_restart_index.bat`, 执行`std_mount_disconnect.sql`

### 一些操作

```plsql
ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE;

ALTER DATABASE RECOVER MANAGED STANDBY DATABASE NODELAY;

ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT FROM SESSION;


```

